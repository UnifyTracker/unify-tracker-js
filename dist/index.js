/*!
 * @unify-tracker/js v0.1.0
 * UnifyTracker JS SDK
 * (c) 2026 UnifyTracker
 * Released under the AGPL-3.0-only license.
 */
"use strict";var ct=Object.create;var x=Object.defineProperty;var lt=Object.getOwnPropertyDescriptor;var ut=Object.getOwnPropertyNames,ve=Object.getOwnPropertySymbols,dt=Object.getPrototypeOf,be=Object.prototype.hasOwnProperty,ft=Object.prototype.propertyIsEnumerable;var G=(e,t,r)=>t in e?x(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,h=(e,t)=>{for(var r in t||(t={}))be.call(t,r)&&G(e,r,t[r]);if(ve)for(var r of ve(t))ft.call(t,r)&&G(e,r,t[r]);return e};var gt=(e,t)=>{for(var r in t)x(e,r,{get:t[r],enumerable:!0})},Te=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of ut(t))!be.call(e,i)&&i!==r&&x(e,i,{get:()=>t[i],enumerable:!(n=lt(t,i))||n.enumerable});return e};var pt=(e,t,r)=>(r=e!=null?ct(dt(e)):{},Te(t||!e||!e.__esModule?x(r,"default",{value:e,enumerable:!0}):r,e)),mt=e=>Te(x({},"__esModule",{value:!0}),e);var v=(e,t,r)=>G(e,typeof t!="symbol"?t+"":t,r);var Lt={};gt(Lt,{default:()=>Ut});module.exports=mt(Lt);function Ee(e,t){let r=null;return function(...n){let i=this;r!==null&&clearTimeout(r),r=setTimeout(()=>{r=null,e.apply(i,n)},t)}}function Se(e){try{let t=window.location.hostname,r=new URL(e,window.location.href).hostname;return!!r&&r!==t}catch(t){return!1}}function ht(e){try{let t="__DOUBLE_ASTERISK_TOKEN__",r="__SINGLE_ASTERISK_TOKEN__",i=e.replace(/\*\*/g,t).replace(/\*/g,r).replace(/[.+?^${}()|[\]\\]/g,"\\$&");i=i.replace(/\//g,"\\/");let s=i.replace(new RegExp(t,"g"),".*").replace(new RegExp(r,"g"),"[^/]+");return new RegExp("^"+s+"$")}catch(t){return a(`Invalid pattern: ${e}`,t),null}}function X(e,t=[]){if(!t||t.length===0)return null;for(let r of t){let n=ht(r);if(n&&n.test(e))return r}return null}function o(...e){l.debug&&console.log("[UnifyTracker]",...e)}function a(...e){l.debug&&console.error("[UnifyTracker Error]",...e)}function C(){let e=new URL(window.location.href),t=e.pathname;return e.hash&&(t+=e.hash),t}var D={debounce:500,skipPatterns:[],maskPatterns:[],debug:!1},b={autoTrackPageviews:!0,autoTrackSpaRoutes:!0,trackQuerystring:!0,trackOutboundLinks:!0,trackWebVitals:!1,captureErrors:!1,enableSessionReplay:!1},$=null,l=new Proxy({},{get:(e,t)=>{var r,n;return $?$[t]:(t!=="debug"&&a("UnifyTracker SDK accessed before initialization. Call uniTracker.init() first."),(n=(r=D[t])!=null?r:b[t])!=null?n:void 0)},set:()=>(a("UnifyTracker config is read-only after initialization."),!1)});async function kt(e,t){var r,n,i,s,u,c,f;try{o("Fetching remote configuration...");let d=new AbortController,P=setTimeout(()=>d.abort(),3e3),w=await fetch(`${e}/site/${t}/tracking-config`,{signal:d.signal});if(clearTimeout(P),w.ok){let m=await w.json();return o("Remote configuration fetched successfully",m),{autoTrackPageviews:(r=m.trackInitialPageView)!=null?r:b.autoTrackPageviews,autoTrackSpaRoutes:(n=m.trackSpaNavigation)!=null?n:b.autoTrackSpaRoutes,trackQuerystring:(i=m.trackUrlParams)!=null?i:b.trackQuerystring,trackOutboundLinks:(s=m.trackOutbound)!=null?s:b.trackOutboundLinks,trackWebVitals:(u=m.webVitals)!=null?u:b.trackWebVitals,captureErrors:(c=m.trackErrors)!=null?c:b.captureErrors,enableSessionReplay:(f=m.sessionReplay)!=null?f:b.enableSessionReplay}}else return a(`Failed to fetch remote config: ${w.status}`),null}catch(d){return d.name==="AbortError"?a("Remote config fetch timed out"):a("Error fetching remote config:",d),null}}async function we(e){var f,d;if($)return a("UnifyTracker SDK already initialized."),!1;if(typeof e!="object"||e===null)return a("Invalid configuration provided to uniTracker.init(). Expected an object."),!1;let t=e.analyticsHost;if(!t||t.trim()==="")return a("`analyticsHost` is required in UnifyTracker config and must be a non-empty string."),!1;let r=t.replace(/\/$/,""),n=e.siteId;if(!n||n.trim()==="")return a("`siteId` is required in UnifyTracker config and must be a non-empty string."),!1;let s=await kt(r,n)||b,u=Array.isArray(e.skipPatterns)?e.skipPatterns:D.skipPatterns,c=Array.isArray(e.maskPatterns)?e.maskPatterns:D.maskPatterns;return $={analyticsHost:r,siteId:n,debounce:Math.max(0,(f=e.debounce)!=null?f:D.debounce),skipPatterns:u,maskPatterns:c,debug:(d=e.debug)!=null?d:D.debug,replayPrivacyConfig:e.replayPrivacyConfig,autoTrackPageviews:s.autoTrackPageviews,autoTrackSpaRoutes:s.autoTrackSpaRoutes,trackQuerystring:s.trackQuerystring,trackOutboundLinks:s.trackOutboundLinks,trackWebVitals:s.trackWebVitals,captureErrors:s.captureErrors,enableSessionReplay:s.enableSessionReplay},!0}var T=null,Y=!1;try{let e=localStorage.getItem("unitracker-user-id");e&&(T=e),localStorage.getItem("disable-unitracker")!==null&&(Y=!0)}catch(e){a("localStorage unavailable")}typeof window!="undefined"&&window.__UNITRACKER_OPTOUT__&&(Y=!0);function p(e,t={}){if(Y){o("Opted out of tracking.");return}if(!l||!l.analyticsHost||!l.siteId){a("UniTracker config not available. Ensure UnifyTracker.init() was called successfully.");return}let{eventName:r,properties:n,pathOverride:i,webVitals:s}=t;if((e==="custom_event"||e==="performance")&&!r){a("Event name is required and must be a string for performance or custom events.");return}try{let u=new URL(window.location.href),c,f="";if(e==="pageview"&&typeof i=="string"&&i.trim()){o(`Using path override: ${i}`);try{let W=new URL(i,"http://dummybase");c=W.pathname,f=W.search||"",o(`Parsed override path: ${c}, search: ${f}`)}catch(W){a(`Invalid pathOverride format: ${i}. Using window location.`),c=C(),f=l.trackQuerystring?u.search:""}}else c=C(),f=l.trackQuerystring?u.search:"";if(e!=="performance"&&X(c,l.skipPatterns)){o(`Skipping track for path: ${c}`);return}let d=X(c,l.maskPatterns);d&&e!=="performance"&&(o(`Masking path ${c} as ${d}`),c=d,f="");let P=h(h(h(h({site_id:l.siteId,hostname:u.hostname,pathname:c,querystring:f,screenWidth:window.screen.width,screenHeight:window.screen.height,language:navigator.language,page_title:document.title,referrer:document.referrer||"direct",type:e},(e==="custom_event"||e==="performance")&&{event_name:r}),(e==="custom_event"||e==="outbound")&&Object.keys(n!=null?n:{}).length>0&&{properties:JSON.stringify(n)}),e==="performance"&&s&&h({},s)),T&&{user_id:T});o("Sending track event:",P);let w=JSON.stringify(P),m=`${l.analyticsHost}/track`;navigator.sendBeacon?navigator.sendBeacon(m,new Blob([w],{type:"application/json"}))||(a("sendBeacon failed, falling back to fetch."),Ce(m,w)):Ce(m,w)}catch(u){a("Error during tracking:",u)}}function Ce(e,t){fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:t,mode:"cors",keepalive:!0}).catch(r=>{a("Fetch request failed:",r)})}function Pe(e){if(e.trim()===""){a("User ID must be a non-empty string");return}T=e.trim();try{localStorage.setItem("unitracker-user-id",T),o("User identified:",T)}catch(t){a("Could not persist user ID to localStorage")}}function Re(){T=null;try{localStorage.removeItem("unitracker-user-id"),o("User ID cleared")}catch(e){a("Could not remove user ID from localStorage")}}function Z(){return T}var E,V=!1,O=[],ee="";function Ue(){if(V){o("Automatic tracking already set up.");return}if(!l.autoTrackPageviews){o("Automatic pageview tracking is disabled.");return}if(o("Setting up automatic tracking..."),ee=C(),E=l.debounce&&l.debounce>0?Ee(()=>{let e=C();Ie(e),p("pageview")},l.debounce):()=>{let e=C();Ie(e),p("pageview")},requestAnimationFrame(()=>{E()}),l.autoTrackSpaRoutes){o("Setting up SPA route change tracking.");let e=history.pushState,t=history.replaceState;history.pushState=function(...r){e.apply(this,r),E()},history.replaceState=function(...r){t.apply(this,r),E()},window.addEventListener("popstate",E)}else o("SPA route change tracking is disabled.");window.addEventListener("hashchange",E),V=!0}function Le(){o("Setting up data attribute and outbound link tracking."),document.addEventListener("click",xe,!0)}function xe(e){if(!(e.target instanceof Element))return;let t=e.target;for(;t;){if(t.hasAttribute("data-unitracker-event")){let r=t.getAttribute("data-unitracker-event");if(r){let n={};for(let i of t.attributes)if(i.name.startsWith("data-unitracker-prop-")){let s=i.name.replace("data-unitracker-prop-","");n[s]=i.value}o("Data attribute event triggered:",r,n),p("custom_event",{eventName:r,properties:n})}break}t=t.parentElement}if(l.trackOutboundLinks&&e.target instanceof Element){let r=e.target.closest("a");if(r&&r.href&&Se(r.href)){o("Outbound link clicked:",r.href);let n={url:r.href,text:r.innerText||r.textContent||"",target:r.target||"_self"};p("outbound",{properties:n})}}}function De(e){return O.push(e),o("Page change callback added"),()=>{O=O.filter(t=>t!==e),o("Page change callback removed")}}function Ie(e){let t=ee;ee=e,t!==e&&(o(`Page changed from ${t} to ${e}`),O.forEach(r=>{try{r(e,t)}catch(n){a("Error in page change callback:",n)}}))}function Oe(){V&&(o("Cleaning up automatic tracking listeners."),window.removeEventListener("popstate",E),window.removeEventListener("hashchange",E),document.removeEventListener("click",xe,!0),O=[],V=!1)}var Be=-1,I=e=>{addEventListener("pageshow",t=>{t.persisted&&(Be=t.timeStamp,e(t))},!0)},k=(e,t,r,n)=>{let i,s;return u=>{t.value>=0&&(u||n)&&(s=t.value-(i!=null?i:0),(s||i===void 0)&&(i=t.value,t.delta=s,t.rating=((c,f)=>c>f[1]?"poor":c>f[0]?"needs-improvement":"good")(t.value,r),e(t)))}},ce=e=>{requestAnimationFrame(()=>requestAnimationFrame(()=>e()))},le=()=>{let e=performance.getEntriesByType("navigation")[0];if(e&&e.responseStart>0&&e.responseStart<performance.now())return e},A=()=>{var t;let e=le();return(t=e==null?void 0:e.activationStart)!=null?t:0},y=(e,t=-1)=>{let r=le(),n="navigate";return Be>=0?n="back-forward-cache":r&&(document.prerendering||A()>0?n="prerender":document.wasDiscarded?n="restore":r.type&&(n=r.type.replace(/_/g,"-"))),{name:e,value:t,rating:"good",delta:0,entries:[],id:`v5-${Date.now()}-${Math.floor(8999999999999*Math.random())+1e12}`,navigationType:n}},te=new WeakMap;function ue(e,t){return te.get(e)||te.set(e,new t),te.get(e)}var ne=class{constructor(){v(this,"t");v(this,"i",0);v(this,"o",[])}h(t){var i;if(t.hadRecentInput)return;let r=this.o[0],n=this.o.at(-1);this.i&&r&&n&&t.startTime-n.startTime<1e3&&t.startTime-r.startTime<5e3?(this.i+=t.value,this.o.push(t)):(this.i=t.value,this.o=[t]),(i=this.t)==null||i.call(this,t)}},_=(e,t,r={})=>{try{if(PerformanceObserver.supportedEntryTypes.includes(e)){let n=new PerformanceObserver(i=>{Promise.resolve().then(()=>{t(i.getEntries())})});return n.observe(h({type:e,buffered:!0},r)),n}}catch(n){}},de=e=>{let t=!1;return()=>{t||(e(),t=!0)}},R=-1,Ae=()=>document.visibilityState!=="hidden"||document.prerendering?1/0:0,B=e=>{document.visibilityState==="hidden"&&R>-1&&(R=e.type==="visibilitychange"?e.timeStamp:0,yt())},_e=()=>{addEventListener("visibilitychange",B,!0),addEventListener("prerenderingchange",B,!0)},yt=()=>{removeEventListener("visibilitychange",B,!0),removeEventListener("prerenderingchange",B,!0)},Ke=()=>{var e;if(R<0){let t=A(),r=document.prerendering||(e=globalThis.performance.getEntriesByType("visibility-state").filter(n=>n.name==="hidden"&&n.startTime>t)[0])==null?void 0:e.startTime;R=r!=null?r:Ae(),_e(),I(()=>{setTimeout(()=>{R=Ae(),_e()})})}return{get firstHiddenTime(){return R}}},K=e=>{document.prerendering?addEventListener("prerenderingchange",()=>e(),!0):e()},Me=[1800,3e3],fe=(e,t={})=>{K(()=>{let r=Ke(),n,i=y("FCP"),s=_("paint",u=>{for(let c of u)c.name==="first-contentful-paint"&&(s.disconnect(),c.startTime<r.firstHiddenTime&&(i.value=Math.max(c.startTime-A(),0),i.entries.push(c),n(!0)))});s&&(n=k(e,i,Me,t.reportAllChanges),I(u=>{i=y("FCP"),n=k(e,i,Me,t.reportAllChanges),ce(()=>{i.value=performance.now()-u.timeStamp,n(!0)})}))})},Fe=[.1,.25],je=(e,t={})=>{fe(de(()=>{let r,n=y("CLS",0),i=ue(t,ne),s=c=>{for(let f of c)i.h(f);i.i>n.value&&(n.value=i.i,n.entries=i.o,r())},u=_("layout-shift",s);u&&(r=k(e,n,Fe,t.reportAllChanges),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&(s(u.takeRecords()),r(!0))}),I(()=>{i.i=0,n=y("CLS",0),r=k(e,n,Fe,t.reportAllChanges),ce(()=>r())}),setTimeout(r))}))},He=0,re=1/0,z=0,vt=e=>{for(let t of e)t.interactionId&&(re=Math.min(re,t.interactionId),z=Math.max(z,t.interactionId),He=z?(z-re)/7+1:0)},ie,Ne=()=>{var e;return ie?He:(e=performance.interactionCount)!=null?e:0},bt=()=>{"interactionCount"in performance||ie||(ie=_("event",vt,{type:"event",buffered:!0,durationThreshold:0}))},We=0,ae=class{constructor(){v(this,"u",[]);v(this,"l",new Map);v(this,"m");v(this,"v")}p(){We=Ne(),this.u.length=0,this.l.clear()}P(){let t=Math.min(this.u.length-1,Math.floor((Ne()-We)/50));return this.u[t]}h(t){var i,s;if((i=this.m)==null||i.call(this,t),!t.interactionId&&t.entryType!=="first-input")return;let r=this.u.at(-1),n=this.l.get(t.interactionId);if(n||this.u.length<10||t.duration>r.T){if(n?t.duration>n.T?(n.entries=[t],n.T=t.duration):t.duration===n.T&&t.startTime===n.entries[0].startTime&&n.entries.push(t):(n={id:t.interactionId,entries:[t],T:t.duration},this.l.set(n.id,n),this.u.push(n)),this.u.sort((u,c)=>c.T-u.T),this.u.length>10){let u=this.u.splice(10);for(let c of u)this.l.delete(c.id)}(s=this.v)==null||s.call(this,n)}}},qe=e=>{let t=globalThis.requestIdleCallback||setTimeout;document.visibilityState==="hidden"?e():(e=de(e),document.addEventListener("visibilitychange",e,{once:!0}),t(()=>{e(),document.removeEventListener("visibilitychange",e)}))},$e=[200,500],Qe=(e,t={})=>{globalThis.PerformanceEventTiming&&"interactionId"in PerformanceEventTiming.prototype&&K(()=>{var c;bt();let r,n=y("INP"),i=ue(t,ae),s=f=>{qe(()=>{for(let P of f)i.h(P);let d=i.P();d&&d.T!==n.value&&(n.value=d.T,n.entries=d.entries,r())})},u=_("event",s,{durationThreshold:(c=t.durationThreshold)!=null?c:40});r=k(e,n,$e,t.reportAllChanges),u&&(u.observe({type:"first-input",buffered:!0}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&(s(u.takeRecords()),r(!0))}),I(()=>{i.p(),n=y("INP"),r=k(e,n,$e,t.reportAllChanges)}))})},oe=class{constructor(){v(this,"m")}h(t){var r;(r=this.m)==null||r.call(this,t)}},Ve=[2500,4e3],Je=(e,t={})=>{K(()=>{let r=Ke(),n,i=y("LCP"),s=ue(t,oe),u=f=>{t.reportAllChanges||(f=f.slice(-1));for(let d of f)s.h(d),d.startTime<r.firstHiddenTime&&(i.value=Math.max(d.startTime-A(),0),i.entries=[d],n())},c=_("largest-contentful-paint",u);if(c){n=k(e,i,Ve,t.reportAllChanges);let f=de(()=>{u(c.takeRecords()),c.disconnect(),n(!0)});for(let d of["keydown","click","visibilitychange"])addEventListener(d,()=>qe(f),{capture:!0,once:!0});I(d=>{i=y("LCP"),n=k(e,i,Ve,t.reportAllChanges),ce(()=>{i.value=performance.now()-d.timeStamp,n(!0)})})}})},ze=[800,1800],se=e=>{document.prerendering?K(()=>se(e)):document.readyState!=="complete"?addEventListener("load",()=>se(e),!0):setTimeout(e)},Ge=(e,t={})=>{let r=y("TTFB"),n=k(e,r,ze,t.reportAllChanges);se(()=>{let i=le();i&&(r.value=Math.max(i.responseStart-A(),0),r.entries=[i],n(!0),I(()=>{r=y("TTFB",0),n=k(e,r,ze,t.reportAllChanges),n(!0)}))})};var H={lcp:null,cls:null,inp:null,fcp:null,ttfb:null},U=!1,j=null;function Tt(){if(U)return;Object.values(H).every(t=>t!==null)&&ge()}function ge(){U||(U=!0,j&&(clearTimeout(j),j=null),o("Sending web vitals data:",H),p("performance",{eventName:"web-vitals",webVitals:H}))}function M(e){if(U)return;let t=e.name.toLowerCase();H[t]=e.value,o(`Collected ${t}:`,e.value),Tt()}function Xe(){if(!l.trackWebVitals){o("Web vitals tracking is disabled.");return}o("Initializing web vitals tracking...");try{Je(M),je(M),Qe(M),fe(M),Ge(M),j=setTimeout(()=>{U||(o("Web vitals timeout reached, sending collected metrics."),ge())},2e4),window.addEventListener("beforeunload",()=>{U||ge()}),o("Web vitals tracking initialized successfully.")}catch(e){a("Error setting up web vitals tracking:",e)}}var F=null,N=null;function Ye(){l.captureErrors&&(o("Setting up error tracking"),F=e=>{Et(e)},N=e=>{St(e)},window.addEventListener("error",F),window.addEventListener("unhandledrejection",N))}function Ze(){F&&(window.removeEventListener("error",F),F=null),N&&(window.removeEventListener("unhandledrejection",N),N=null),o("Error tracking cleaned up")}function Et(e){var s,u;let t=window.location.origin,r=e.filename||"";if(r)try{if(new URL(r).origin!==t){o("Skipping third-party error:",r);return}}catch(c){}let n=((s=e.error)==null?void 0:s.stack)||"";if(!r&&n&&!n.includes(t)){o("Skipping third-party error based on stack trace");return}let i={message:(e.message||"Unknown error").substring(0,500),stack:n.substring(0,2e3),filename:r||void 0,lineno:e.lineno||void 0,colno:e.colno||void 0,timestamp:Date.now()};q(((u=e.error)==null?void 0:u.name)||"Error",i)}function St(e){let t="Unhandled promise rejection",r="";e.reason instanceof Error?(t=e.reason.message||t,r=e.reason.stack||""):typeof e.reason=="string"?t=e.reason:e.reason&&typeof e.reason=="object"&&(t=JSON.stringify(e.reason));let n={message:t.substring(0,500),stack:r.substring(0,2e3),timestamp:Date.now()};q("UnhandledRejection",n)}function q(e,t,r){let n=h({error_name:e,message:t.message},r);t.stack&&(n.stack=t.stack),t.filename&&(n.filename=t.filename),t.lineno&&(n.line_number=t.lineno),t.colno&&(n.column_number=t.colno),p("error",{eventName:e,properties:n})}function et(e,t){var r,n;if(!l.captureErrors){a("Error tracking is not enabled. Set captureErrors: true in config.");return}if(e instanceof ErrorEvent){let i={message:(e.message||"Unknown error").substring(0,500),stack:(((r=e.error)==null?void 0:r.stack)||"").substring(0,2e3),filename:e.filename||void 0,lineno:e.lineno||void 0,colno:e.colno||void 0,timestamp:Date.now()};q(((n=e.error)==null?void 0:n.name)||"Error",i,t)}else{let i={message:(e.message||"Unknown error").substring(0,500),stack:(e.stack||"").substring(0,2e3),timestamp:Date.now()};q(e.name||"Error",i,t)}}var J=null,L=!1,pe=null,S=[],Q,me=null,he;function wt(){return`${Date.now()}-${Math.random().toString(36).substring(2,15)}`}async function tt(e){if(l.enableSessionReplay){he=e,me=wt();try{J=(await import("rrweb")).record,o("rrweb loaded successfully"),rt()}catch(t){a("Failed to load rrweb. Make sure it's installed as a peer dependency:",t)}}}function rt(){var e;if(!(L||!J||!l.enableSessionReplay))try{let t=l.replayPrivacyConfig||{},r={emit:n=>{Ct({type:n.type,data:n.data,timestamp:n.timestamp||Date.now()})},recordCanvas:!1,collectFonts:!1,checkoutEveryNms:6e4,checkoutEveryNth:500,maskAllInputs:(e=t.maskAllInputs)!=null?e:!0,maskInputOptions:{password:!0,email:!0},slimDOMOptions:{script:!1,comment:!0,headFavicon:!0,headWhitespace:!0,headMetaDescKeywords:!0,headMetaSocial:!0,headMetaRobots:!0,headMetaHttpEquiv:!0,headMetaAuthorship:!0,headMetaVerification:!0},sampling:{mousemove:!1,mouseInteraction:{MouseUp:!1,MouseDown:!1,Click:!0,ContextMenu:!1,DblClick:!0,Focus:!0,Blur:!0,TouchStart:!1,TouchEnd:!1},scroll:500,input:"last",media:800}};t.maskTextSelectors&&t.maskTextSelectors.length>0&&(r.maskTextSelector=t.maskTextSelectors.join(", ")),pe=J(r),L=!0,Pt(),o("Session replay recording started")}catch(t){a("Failed to start session replay recording:",t)}}function nt(){if(!l.enableSessionReplay){a("Session replay is not enabled. Enable it via remote config.");return}if(!J){a("rrweb is not loaded. Ensure it's installed as a peer dependency.");return}if(L){o("Session replay is already recording");return}rt()}function ke(){if(!L){o("Session replay is not currently recording");return}pe&&pe(),L=!1,at(),S.length>0&&ye(),o("Session replay recording stopped")}function it(){return L}function Ct(e){S.push(e),S.length>=250&&ye()}function Pt(){at(),Q=window.setInterval(()=>{S.length>0&&ye()},5e3)}function at(){Q!==void 0&&(clearInterval(Q),Q=void 0)}function ye(){if(S.length===0||!me)return;let e=[...S];S=[];let t={sessionId:me,siteId:l.siteId,userId:he,events:e,metadata:{pageUrl:window.location.href,screenWidth:window.screen.width,screenHeight:window.screen.height,language:navigator.language}};Rt(t).catch(r=>{a("Failed to send session replay batch:",r),S.unshift(...e)})}async function Rt(e){let t=`${l.analyticsHost}/replay`,r=JSON.stringify(e),n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:r,mode:"cors",keepalive:!0});if(!n.ok)throw new Error(`Failed to send replay batch: ${n.status}`);o(`Session replay batch sent: ${e.events.length} events`)}function ot(e){he=e}function st(){ke()}var g=!1,It={init:async e=>{if(g){a("UnifyTracker SDK already initialized. Call init() only once.");return}await we(e)&&(g=!0,o("Config:",h({},l)),Ue(),Le(),Xe(),Ye(),await tt(Z()||void 0))},pageview:e=>{if(!g){a("UnifyTracker SDK not initialized. Call uniTracker.init() first.");return}p("pageview",{pathOverride:e})},event:(e,t)=>{if(!g){a("UnifyTracker SDK not initialized. Call uniTracker.init() first.");return}if(!e){a("Event name is required and must be a string.");return}p("custom_event",{eventName:e,properties:t})},outbound:(e,t="",r="_self")=>{if(!g){a("UnifyTracker SDK not initialized. Call uniTracker.init() first.");return}if(!e){a("Outbound link URL is required and must be a string.");return}p("outbound",{properties:{url:e,text:t,target:r}})},identify:e=>{if(!g){a("UnifyTracker SDK not initialized. Call uniTracker.init() first.");return}Pe(e),ot(e)},clearUserId:()=>{if(!g){a("UnifyTracker SDK not initialized. Call uniTracker.init() first.");return}Re()},getUserId:()=>g?Z():(a("UnifyTracker SDK not initialized. Call uniTracker.init() first."),null),captureError:(e,t)=>{if(!g){a("UnifyTracker SDK not initialized. Call uniTracker.init() first.");return}et(e,t)},onPageChange:e=>g?De(e):(a("UnifyTracker SDK not initialized. Call uniTracker.init() first."),()=>{}),startSessionReplay:()=>{if(!g){a("UnifyTracker SDK not initialized. Call uniTracker.init() first.");return}nt()},stopSessionReplay:()=>{if(!g){a("UnifyTracker SDK not initialized. Call uniTracker.init() first.");return}ke()},isSessionReplayActive:()=>g?it():(a("UnifyTracker SDK not initialized. Call uniTracker.init() first."),!1),cleanup:()=>{Oe(),Ze(),st(),g=!1}},Ut=It;
